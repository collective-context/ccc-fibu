/*.ta M_KeyCode()
ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
บ  M_KeyCode()                                                                 บ
ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ

berblick:
ฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
#include <eur_tool.h>
VOID M_KeyCode(apWkbMask, swKeyCode, pswMsk, pswFld, pswBlockNumber,
  apTextBox, apstrRecord, awRecLen, awBlocks)

Parameter:
ฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
PWKB     apWkbMask[]        Zeiger auf Array fr die Maskenattribute.
SWORD    swKeyCode
PSWORD   pswMsk
PSWORD   pswFld
PSWORD   pswBlockNumber
PTEXTBOX apTextBox[][99]
PSTR     apstrRecord[]
WORD     awRecLen[]
WORD     awBlocks[][2])

Beschreibung:
ฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
Diese Funktion bildet aus der Sicht des Applikations-Programmierers die

Diese Funktion ist eine Hilfsfunktion des Maskentools. Die Funktion
muแ aufgerufen werden, um dem Maskeninterpreter mitzuteilen, wann er die
Defaultwerte aus der Maskendefinition (siehe Default-Anweisung Masken-
Compiler) einzusetzen hat. Da der Masken-Interpreter nicht von sich aus
entscheiden kann, ob es sich bei einem Datensatz um eine Neuanlage handelt
oder nicht. Nur im Falle einer Neuanlage ist es sinnvoll, Defaultwerte in
den Datensatz zu schreiben. Bei einem Aufruf von Defaults () werden alle
Felder in record[] mit Default-Werten belegt, die auch eine Default-
Anweisung in der Maskendefinition haben. Ein eventuell zu kurzer Masken-
Record, wird dabei auf die ntige Lnge ergnzt, in dem der Zwischenraum
mit Low-Values (ASCII 0) aufgefllt wird. Beim Aufruf von Defaults () werden
die Default-Werte aller Masken eingetragen, die mit Mask als zusammenge-
hrige Masken angemeldet wurden.
Default-Werte werden nur fr eingabe-Felder gesetzt.
Versorgung:
   Eingang:
   char *record[];
      Ist das Feld der Masken-Records, die mit Default-Werten sollen. Das
     Feld muแ so groแ dimensioniert werden, wie Masken-Records in der
      Maskendefinition verwendet werden.
   int record_number;
      Legt fest, welcher Masken-Record mit Default-Werten belegt werden
      soll. Eine Angabe von -1 bewirkt, daแ alle Masken-Records, fr die
      eine Default-Anweisung in der Maskendefinition gegeben wurde, belegt
      werden.

 Diese Funktion ist eine Hilfsfunktion des Maskentools. Mit Ihr kann
 die Feldposition ermittelt werden, auf die der Interpreter als
 nchstes verzweigen wrde, wenn er von der angegeben Feldposition
 aus den angegebenen key_code interpretieren wrde.
 Somit lassen sich applikationsabhngige Vorbelegungen realisieren.
 Versorgung:
    Eingang:
    int key_code;
       Gibt den Key-Code an, den der Interpreter interpretieren soll.
    Ein-/ Ausgang:
    int field_number;
       Gibt die Applikations-Feldnummer an, von der der Interpreter ausgehen
       soll. Bei Rckkehr in den aufrufenden Programmteil enthlt field_
       number die aus der Interpretation resultierende Feldnummer.
    int mask_number;
       Beinhaltet die Masekennummer. von der ausgehend der Interpreter den
       Key-Code interpretieren soll. Die Maskennummer muแ nicht mit der
       Nummer der aktuellen Maske bereinstimmen. Die aktuelle Maske wird
       jedoch nicht durch diese Routine verndert.
       Beim Rcksprung in den aufrufenden Programmteil beinhaltet mask_number
       die Nummer der Maske, in der sich das Zielfeld (field_number) be-
       findet.

Rckgabewert:
ฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
WORD  Fehlerinformation OK/ERROR


Benutzte globale Variablen (R/W):
ฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
Variablen (R/W):  - aCS_g[]    (R)           - pstrEsc_g   (R)
                  - wCSInd_g   (R)           - pstrF1_g    (R)
                  - wMausda_g  (R)           - boBeepen_g  (R)
.ff
REM .de \euro\demo\dmohilf1.c
.te*/

/*ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ                        DEKLARATIONS-DATEIEN                            บ
  ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
#include <stdio.h>
#include <string.h>
#include <math.h>
#include <ctype.h>              /* isdigit(),                                */
#include <eur_tool.h>

/*ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ                      FUNKTIONS-PROTOTYPEN                              บ
  ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
STATIC VOID  i_BlockKeyCode	 (SWORD, WORD, PSWORD, PSWORD, PTEXTBOX[][99],
				  PSTR[], WORD[], WORD[][2]);
STATIC WORD  i_Hide		 (PSWORD, PSWORD, PTEXTBOX[][99]);
GLOBAL WORD  i_TooBig            (VOID); /* aus m_input.c GLOBAL */

/*ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ         GLOBALE DATEN, DIE AUS DER TOOLBOX IMPORTIERT WERDEN           บ
  ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
IMPORT PWKB   pWkbInfo_g;
IMPORT BOOL   boTestModus_g;
IMPORT WORD   awHideMsk_g[];             /* Masken verstecken ja/nein                                 */
IMPORT BOOL   boInM_Input_g;
IMPORT WORD   awBlockLength_g[];
IMPORT BOOL   aboInBlock_g[];            /* aus m_input.c GLOBAL */
IMPORT SWORD  aswAktLine_g[];            /* aus m_input.c GLOBAL */
IMPORT WORD   awHoehe_g[];               /* aus m_input.c GLOBAL */
IMPORT WORD   awMaxLine_g[];             /* aus m_input.c GLOBAL */
IMPORT WORD   awBlockLen_g[];            /* aus m_input.c GLOBAL */
IMPORT SWORD  aswAktStartLine_g[];       /* aus m_input.c GLOBAL */
IMPORT PEVENT pEvent_g;
IMPORT BOOL   bo_S_PGUP_g;               /* aus m_input.c GLOBAL */
IMPORT BOOL   bo_S_PGDOWN_g;             /* aus m_input.c GLOBAL */

IMPORT LONG	lBlockVer_g;			     /* 0==Kein Block	     */
						     /* BLOCK	 1==&BLOCK   */
						     /* BROWSE	 2==&BROWSE  */
						     /* BLK_TYP2 4==mbc.exe  */
/*ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ                          FUNKTIONS-DEFINITION                          บ
  ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
GLOBAL
VOID M_KeyCode(PWKB apWkbMask[], SWORD swKeyCode, PSWORD pswMsk,
  PSWORD pswFld, PSWORD pswBlockNumber, PTEXTBOX apTextBox[][99],
  PSTR apstrRecord[], WORD awRecLen[], WORD awBlocks[][2])
{
REGISTER i;
LONG lBrowse=BROWSE, lBlock=BLOCK;
WORD  wMaxMask;
SWORD wFirstField=i_FirstFld(apTextBox[*pswMsk]);    /* erste FeldNr         */
WORD  wMaxField=i_MaxFld(apTextBox[*pswMsk]);        /* hhste FeldNummer    */

for(i=0; apWkbMask[i]; i++)
  if(awHideMsk_g[i]==NEIN) wMaxMask=i;		     /* hhste Maskennummer  */

switch(swKeyCode)                                    /* sonst nchst. FeldNr */
  {
  case T_RETURN:                                     /* Return               */
  case T_DOWN:                                       /* Cursor abwrts       */
    ++(*pswFld);
    while(*pswFld<=wMaxField && *pswMsk<=wMaxMask &&
      i_Hide(pswMsk, pswFld, apTextBox) )
      ++(*pswFld);
  break;

  case T_UP:                                         /* Cursor aufwrts      */
    --(*pswFld);
    while(*pswFld>=wFirstField && *pswMsk>=0 &&
      i_Hide(pswMsk, pswFld, apTextBox) )
      --(*pswFld);
    break;

  case T_C_PGUP:
    --(*pswMsk);
    while(*pswMsk>=0 && awHideMsk_g[*pswMsk])
      --(*pswMsk);

    if(*pswMsk<0) *pswMsk=0;
    break;

  case T_C_PGDN:
    ++(*pswMsk);
    while(*pswMsk<=wMaxMask && awHideMsk_g[*pswMsk])
      ++(*pswMsk);

    if(*pswMsk>wMaxMask) *pswMsk=wMaxMask;
    break;
  }  /*end swKeyCode */

if(boInM_Input_g || awBlockLength_g[*pswMsk]==0      /* ~ */
  || lBlockVer_g&lBrowse)
  {
  wFirstField=i_FirstFld(apTextBox[*pswMsk]);	     /* erste FeldNummer     */
  wMaxField=i_MaxFld(apTextBox[*pswMsk]);            /* hhste FeldNummer    */

  if(*pswFld>wMaxField) *pswFld=wMaxField;
  if(*pswFld<wFirstField) *pswFld=wFirstField;
  }
else
  i_BlockKeyCode(swKeyCode, *pswMsk, pswFld,
    pswBlockNumber, apTextBox, apstrRecord,
    awRecLen, awBlocks);

return;
} /* end M_KeyCode() */


/*ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ i_BlockKeyCode()				      Datum: 17.12.91	   บ
  วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
  บ                                                                        บ
  ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
STATIC
VOID i_BlockKeyCode(SWORD wKeyCode, WORD wMsk, PSWORD pwFld,
		    PSWORD pswBlockNumber, PTEXTBOX apTextBox[][99],
		    PSTR apstrRecord[], WORD awRecLen[], WORD awBlocks[][2])
{
WORD wRecLen, wRec, wMaxField;
SWORD wFirstField;

*pswBlockNumber=aswAktLine_g[wMsk];
if(pEvent_g->wKbflags & (LEFT_SHIFT|RIGHT_SHIFT|CTRL))
  {
  if(aboInBlock_g[wMsk] && wKeyCode == T_UP)
    {
    (*pwFld)++;
    (*pswBlockNumber)--;
    }
  else if (aboInBlock_g[wMsk] && wKeyCode == T_DOWN)
    {
     (*pwFld)--;
     (*pswBlockNumber)++;
    }
  }

if(aboInBlock_g[wMsk] && *pwFld > awBlocks[wMsk][1])
  {
  *pwFld=awBlocks[wMsk][0];
  (*pswBlockNumber) ++;
  if(*pswBlockNumber > awMaxLine_g[wMsk] - 1)
     awMaxLine_g[wMsk]=*pswBlockNumber + 1;
  }

if(aboInBlock_g[wMsk] && *pwFld < awBlocks[wMsk][0]
  && *pswBlockNumber > 0)
  {
  *pwFld = awBlocks[wMsk][1];
  (*pswBlockNumber) --;
  }

wRec=apTextBox[wMsk][awBlocks[wMsk][0]]->wRecord;
wRecLen=apTextBox[wMsk][awBlocks[wMsk][0]]->wOffset +
	  awBlockLen_g[wMsk] * awMaxLine_g[wMsk];
if(wRecLen>19800) i_TooBig ();

if(awBlockLen_g[wMsk] && awRecLen[wRec] < wRecLen)
  {
  PSTR pstrTmp=NULL;
  Ut_Calloc(pstrTmp, wRecLen, CHAR);

  memcpy(pstrTmp, apstrRecord[wRec], awRecLen[wRec]);
  Ut_Free(apstrRecord[wRec]);
  apstrRecord[wRec]=pstrTmp;
  awRecLen[wRec]=wRecLen;
  } /* end awRecLen[wRec] < wRecLen) */

wFirstField=i_FirstFld(apTextBox[wMsk]);	  /* erste FeldNummer	  */
wMaxField=i_MaxFld(apTextBox[wMsk]);		  /* hhste FeldNummer	  */

if(*pwFld>wMaxField) *pwFld=wMaxField;
if(*pwFld<wFirstField) *pwFld=wFirstField;

return;
} /* end i_BlockKeyCode() */


/*ษอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ i_HoldMask()                                                            บ
  บ ฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ บ
  บ Verhindert das weiterblttern auf eine zweite Bildschirmmakse.          บ
  ศอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
GLOBAL
WORD i_HoldMask(PWORD pwKeyCode, PWORD pwFieldNr, PTEXTBOX apTB[][99],
                WORD wMsk, WORD wFld)
{
WORD wMaxField=i_MaxFld(apTB[wMsk]);		     /* hhste FeldNummer    */

if(apTB[wMsk][wFld]->wSequenz > wMaxField &&
  *pwFieldNr < wMaxField)
  {*pwKeyCode=AUS; *pwFieldNr++;}

if((*pwKeyCode==T_DOWN || *pwKeyCode==T_RETURN) &&
  *pwFieldNr==wMaxField)
  {*pwKeyCode=AUS;
  *pwFieldNr=i_FirstFld(apTB[wMsk]);}		     /* erste FeldNummer     */

if(*pwKeyCode==T_C_PGDN) *pwKeyCode=AUS;
return(OK);
} /* end i_HoldMask() */


/*ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ i_Hide()					      Datum: 17.12.91	   บ
  วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
  บ                                                                        บ
  ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
STATIC
WORD i_Hide(PSWORD pswMsk, PSWORD pswFld, PTEXTBOX apTextBox[][99] )
{
WORD wRetCode=
  (apTextBox[*pswMsk][*pswFld]->wHide ||
  (apTextBox[*pswMsk][*pswFld]->pFeld &&
  !(apTextBox[*pswMsk][*pswFld]->pFeld->bArt & IS_EINGABE)) );

return(wRetCode);
} /* end i_Hide() */


/*ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ i_MaxFld()					      Datum: 17.12.91	   บ
  วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
  บ                                                                        บ
  ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
GLOBAL
WORD i_MaxFld(PTEXTBOX apTB[])                          /* hoehste FeldNummer   */
{
REGISTER i;
WORD wMaxFld;

for(wMaxFld=i=0; apTB[i]; i++)
  if(! apTB[i]->wHide)
    wMaxFld=i;

return(wMaxFld);
} /* end i_MaxFld() */


/*ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ i_FirstFld()				      Datum: 17.12.91	   บ
  วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
  บ                                                                        บ
  ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
GLOBAL
SWORD i_FirstFld(PTEXTBOX apTB[])                    /* erste FeldNummer     */
{
REGISTER i;
SWORD wFirstFld;

for(wFirstFld=i=0; apTB[i] && apTB[i]->wHide; i++)
   wFirstFld=i;

/*Wi_TestPrintf(pWkbInfo_g, "\nwFirstFld(%d), apTB[%d]->wHide(%d), "
  "apTB[%d]->strDatenfeld(%s), apTB[%d](%d).", wFirstFld, i,
  apTB[i]->wHide, i, apTB[i]->strDatenfeld, i, apTB[i]);*/

return(wFirstFld);
} /* end i_FirstFld() */


/*ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
  บ M_KeyEvaluation()				      Datum: 17.12.91	   บ
  วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
  บ                                                                        บ
  ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ*/
/* --- Beginn M_KeyEvaluation() */
GLOBAL
VOID M_KeyEvaluation(PWKB apWkbMask[], PSWORD pswKeyCode, PSWORD pswMsk,
  PSWORD pswField, PTEXTBOX apTextBox[][99], PSTR apstrRecord[],
  SWORD awRecLen[], SWORD awBlocks[][2], SWORD awScroll[][4],
  PSWORD pwFirstField, PWORD pwMaxField, PWORD pwMaxMask,
  PWORD pwFensterZ, PWORD pwFensterS, WORD wAlteMaske)
{
LONG lBrowse=BROWSE, lBlock=BLOCK;
WORD wMaskAlt;
SWORD swBlockNb;                                     /* ~ Hilfsvariable !!!  */
REGISTER i,j;

if(wAlteMaske != *pswMsk)
  {aboInBlock_g[wAlteMaske]=NEIN;
  aswAktLine_g[wAlteMaske]=0;}

*pwFirstField=i_FirstFld(apTextBox[*pswMsk]);         /* erste FeldNummer     */
*pwMaxField=i_MaxFld(apTextBox[*pswMsk]);             /* hhste FeldNummer    */
for(i=0; apWkbMask[i]; i++) *pwMaxMask=i;              /* hhste Maskennummer  */

for(j=0; j <= *pwMaxMask; j++)                  /* Aus dem Datensatz den Inhalt */
   {
   if(lBlockVer_g&lBlock && !awBlockLen_g[j])
     if(awBlocks[j][0] | awBlocks[j][1])
       {awBlockLen_g[j]=apTextBox[j][awBlocks[j][1]]->wOffset
       -apTextBox[j][awBlocks[j][0]]->wOffset
       +apTextBox[j][awBlocks[j][1]]->wMaxL+1;
       awHoehe_g[j]=awScroll[j][2] -awScroll[j][0] +1;}

   for(i=0; apTextBox[j][i] != NULL; i++)     /* fr Bildschirm holen         */
     {
     WORD wRec=apTextBox[j][i]->wRecord;                    /* Dateinummer   */
     /* WORD wOff=apTextBox[j][i]->wOffset; */
     if(lBlockVer_g&lBlock && awBlockLen_g[j])
       if((awBlocks[j][0] | awBlocks[j][1]) &&
         wRec==apTextBox[j][awBlocks[j][0]]->wRecord)
         awMaxLine_g[j]=(((awRecLen[wRec]
           -apTextBox[j][awBlocks[j][0]]->wOffset)
           /awBlockLen_g[j]) > awMaxLine_g[j])
           ? ((awRecLen[wRec]
             -apTextBox[j][awBlocks[j][0]]->wOffset)
             /awBlockLen_g[j])
           : awMaxLine_g[j];
     }
   }


if(*pswKeyCode==T_RETURN)             /* Bei Return, nchste Feldnummer laut Sequenz-Anweisung suchen  */
  if(lBlockVer_g&lBlock && aboInBlock_g[*pswMsk])
    if(*pswField==awBlocks[*pswMsk][1])
      {
      *pswField=awBlocks[*pswMsk][0];
      aswAktLine_g[*pswMsk]++;
      if(aswAktLine_g[*pswMsk] > awMaxLine_g[*pswMsk] -1)
        awMaxLine_g[*pswMsk]=aswAktLine_g[*pswMsk] +1;
      }
    else (*pswField)++;
  else *pswField=apTextBox[*pswMsk][*pswField]->wSequenz;
else                                    /* sonst nchste Feldnummer suchen */
  {
  *pwFensterZ=apTextBox[*pswMsk][*pswField]->wFensterZ;
  if(lBlockVer_g&lBlock && aboInBlock_g[*pswMsk])
    *pwFensterZ=*pwFensterZ +(aswAktLine_g[*pswMsk]
    -aswAktStartLine_g[*pswMsk]);

  *pwFensterS=apTextBox[*pswMsk][*pswField]->wFensterS;
  wMaskAlt=*pswMsk;

  boInM_Input_g=JA;
  M_KeyCode(apWkbMask, *pswKeyCode, pswMsk, pswField,
    &swBlockNb, apTextBox, apstrRecord, awRecLen, awBlocks);
  boInM_Input_g=NEIN;

  if(*pswMsk != wMaskAlt && *pswMsk >= 0 && *pswMsk <= *pwMaxMask)
   {aboInBlock_g[wMaskAlt]=NEIN;
   aswAktLine_g[wMaskAlt]=0;}
  }

/*Wi_TestPrintf (pWkbInfo_g, "Stop (1) in M_Input() *pwMaxField = %d.\n", *pwMaxField);*/

if(*pswField < 0 && (lBlockVer_g&lBrowse ||	 /* Eingabefeld im erlaubten */
  !aboInBlock_g[*pswMsk] || aswAktLine_g[*pswMsk]==0))
  {
  aboInBlock_g[*pswMsk]=NEIN;
  if(*pswMsk > 0) --(*pswMsk); else *pswMsk=0;
						      /* Bereich halten       */
  *pwFirstField=i_FirstFld(apTextBox[*pswMsk]);       /* erste FeldNummer     */
  *pswField=*pwMaxField=i_MaxFld(apTextBox[*pswMsk]); /* hhste FeldNummer    */
  }

if(*pswField > *pwMaxField &&
  (lBlockVer_g&lBrowse || !aboInBlock_g[*pswMsk] ||
  *pswKeyCode==T_C_PGUP || *pswKeyCode==T_C_PGDN))
  {
  aboInBlock_g[*pswMsk]=NEIN;

  if(*pswKeyCode!=T_RETURN)
    {if(*pswMsk<*pwMaxMask) ++*pswMsk; else *pswMsk=*pwMaxMask;}

  *pswField=*pwFirstField=i_FirstFld(apTextBox[*pswMsk]); /* erste FeldNummer */
  *pwMaxField=i_MaxFld(apTextBox[*pswMsk]);           /* hhste FeldNummer    */
  }

if(lBlockVer_g&lBlock && aboInBlock_g[*pswMsk] &&
  *pswField > awBlocks[*pswMsk][1])
  {
  *pswField=awBlocks[*pswMsk][0];
  aswAktLine_g[*pswMsk] ++;
  if(aswAktLine_g[*pswMsk] > awMaxLine_g[*pswMsk] - 1)
    awMaxLine_g[*pswMsk] = aswAktLine_g[*pswMsk] + 1;
  }

if(lBlockVer_g&lBlock && aboInBlock_g[*pswMsk] &&
  *pswField < awBlocks[*pswMsk][0] &&
  aswAktLine_g[*pswMsk] > 0)
  {
  *pswField=awBlocks[*pswMsk][1];
  aswAktLine_g[*pswMsk] --;
  }

if(lBlockVer_g&lBlock && awBlockLen_g[*pswMsk] &&
  *pswField >= awBlocks[*pswMsk][0] &&
  *pswField <= awBlocks[*pswMsk][1])
  aboInBlock_g[*pswMsk] = JA;
else
  {aswAktLine_g[*pswMsk]=0;
  aboInBlock_g[*pswMsk]=NEIN;}

if(*pswKeyCode==T_C_HOME)             /* Bei CTRL-HOME Maskenanfang          */
  {*pswField=*pwFirstField=
    i_FirstFld(apTextBox[*pswMsk]);                     /* erste FeldNummer */
  aboInBlock_g[*pswMsk]=NEIN;
  aswAktLine_g[*pswMsk]=0;}

if(*pswKeyCode==T_C_END)              /* Bei CTRL-END Maskenende             */
  {
  *pswField=*pwMaxField;
  if(lBlockVer_g&lBlock && awBlockLen_g[*pswMsk])
    {aboInBlock_g[*pswMsk]=JA;
    aswAktLine_g[*pswMsk]=awMaxLine_g[*pswMsk] - 1;}
  }

if(pEvent_g->wKbflags & (LEFT_SHIFT|RIGHT_SHIFT|CTRL))
  {
  switch(*pswKeyCode)
    {
    case T_DOWN:                             /* Cursor abwrts               */
      if(lBlockVer_g&lBlock && aboInBlock_g[*pswMsk])
        {
        if(*pswField==awBlocks[*pswMsk][0])
          *pswField=awBlocks[*pswMsk][1];
        else
	  /* {if(!(lBlockVer_g&lBrowse)) aswAktLine_g[*pswMsk] ++; */
	  {aswAktLine_g[*pswMsk] ++;
	  if(*pswField>awBlocks[*pswMsk][0]) (*pswField)--;}
        }
      else if( !(lBlockVer_g&lBrowse && awBlocks[*pswMsk][1]) )
        {
        while(apTextBox[*pswMsk][*pswField]->wFensterZ == *pwFensterZ)
          if(++(*pswField) > *pwMaxField)
            *pswField=i_FirstFld(apTextBox[*pswMsk]); /* erste FeldNr   */

        *pwFensterZ=apTextBox[*pswMsk][*pswField]->wFensterZ;
        while(apTextBox[*pswMsk][*pswField]->wFensterS > *pwFensterS
          && apTextBox[*pswMsk][*pswField]->wFensterZ == *pwFensterZ)
          if(++(*pswField) > *pwMaxField)
            *pswField=i_FirstFld(apTextBox[*pswMsk]); /* erste FeldNr   */
        }
      break;

    case T_UP:                        /* Cursor aufwrts               */
      if(lBlockVer_g&lBlock && aboInBlock_g[*pswMsk])
        {
        if(*pswField == awBlocks[*pswMsk][1])
          *pswField = awBlocks[*pswMsk][0];
        else
	  {if(!(lBlockVer_g&lBrowse && awBlocks[*pswMsk][1]))
	     aswAktLine_g[*pswMsk] --;
	     (*pswField)++;}
        }
      else if( !(lBlockVer_g&lBrowse && awBlocks[*pswMsk][1]) )
        {
        while(apTextBox[*pswMsk][*pswField]->wFensterZ == *pwFensterZ)
          if(--(*pswField) < 0) *pswField=*pwMaxField;

        *pwFensterZ=apTextBox[*pswMsk][*pswField]->wFensterZ;
        while(apTextBox[*pswMsk][*pswField]->wFensterS > *pwFensterS
          && apTextBox[*pswMsk][*pswField]->wFensterZ == *pwFensterZ)
          if(--(*pswField) < 0) *pswField = *pwMaxField;
        }
      break;
    } /* end case */
  }/* Shift Taste gedrckt */

if(bo_S_PGUP_g && lBlockVer_g&lBlock && aboInBlock_g[*pswMsk])
  {
  aswAktLine_g[*pswMsk] -= awHoehe_g[*pswMsk] - 1;
  if(aswAktLine_g[*pswMsk] < 0)
    aswAktLine_g[*pswMsk] = 0;
  }

if(bo_S_PGDOWN_g && lBlockVer_g&lBlock && aboInBlock_g[*pswMsk])
  {
  aswAktLine_g[*pswMsk] += awHoehe_g[*pswMsk] - 1;
  if(aswAktLine_g[*pswMsk] > awMaxLine_g[*pswMsk] - 1)
    aswAktLine_g[*pswMsk] = awMaxLine_g[*pswMsk] - 1;
  }

for(i=0; apWkbMask[i] != NULL; i++) *pwMaxMask=i;          /* hoehste MaskenNr */
*pwMaxField=i_MaxFld(apTextBox[*pswMsk]);             /* hhste FeldNummer    */

if(*pswMsk <0) *pswMsk  = 0;                /* Masken-Anzeige im erlaubten */
if(*pswMsk >*pwMaxMask)  *pswMsk = *pwMaxMask;   /* Bereich halten             */
if(*pswField<0) *pswField=i_FirstFld(apTextBox[*pswMsk]); /* erste FeldNr   */
if(*pswField>*pwMaxField) *pswField = *pwMaxField; /* Bereich halten             */

while(*pswField<=*pwMaxField && 		     /* wegen Hide in Browse */
  !(apTextBox[*pswMsk][*pswField]->pFeld->bArt & IS_EINGABE))
  {
  if(*pswKeyCode == T_UP || *pswKeyCode == T_C_END)
    {
    (*pswField)--;
    if(*pswField < awBlocks[*pswMsk][0] && lBlockVer_g&lBlock &&
      aboInBlock_g[*pswMsk] && aswAktLine_g[*pswMsk] > 0)
      {
      aswAktLine_g[*pswMsk]--;
      *pswField = awBlocks[*pswMsk][1];
      }
    else
      if(*pswField < 0)
	if(lBlockVer_g&lBlock && aboInBlock_g[*pswMsk] &&
	  aswAktLine_g[*pswMsk] > 0)
          {
          aswAktLine_g[*pswMsk]--;
          *pswField = awBlocks[*pswMsk][1];
          }
	else if( !(lBlockVer_g&lBrowse && awBlocks[*pswMsk][1]) )
          {
          (*pswMsk)--;
          if(*pswMsk < 0)
            {
            *pswMsk = 0;
            *pswField=i_FirstFld(apTextBox[*pswMsk]);   /* erste FeldNr    */
            *pswKeyCode = T_DOWN;
            }
          else
            *pswField=*pwMaxField=i_MaxFld(apTextBox[*pswMsk]); /* hhste FeldNr */
          }
    } /* if T_UP || T_END */

  if(*pswKeyCode != T_UP && *pswKeyCode != T_C_END)
    {
    (*pswField)++;
    if(*pswField > *pwMaxField)
      if(lBlockVer_g&lBlock && aboInBlock_g[*pswMsk])
        {
        *pswField = awBlocks[*pswMsk][0];
        aswAktLine_g[*pswMsk] ++;
        if(aswAktLine_g[*pswMsk] > awMaxLine_g[*pswMsk] - 1)
        awMaxLine_g[*pswMsk] = aswAktLine_g[*pswMsk] + 1;
        }
      else if( !(lBlockVer_g&lBrowse && awBlocks[*pswMsk][1]) )
        {
        (*pswMsk)++;
        if(*pswMsk > *pwMaxMask)
          {
          *pswMsk = *pwMaxMask;
          *pswField = *pwMaxField;
          *pswKeyCode = T_UP;
          }
        else
          {
          *pwMaxField=i_MaxFld(apTextBox[*pswMsk]);    /* hhste FeldNr    */
          *pswField=i_FirstFld(apTextBox[*pswMsk]);  /* erste FeldNr     */
          }
        }
    }  /* if T_DOWN || T_RETURN || T_C_HOME */
  } /* end while !IS_EINGABE */

if(lBlockVer_g&lBrowse && awBlocks[*pswMsk][1] &&
  *pswField>*pwMaxField)     /* wegen Hide in Browse */
  {*pswField=awBlocks[*pswMsk][1];
  while(!(apTextBox[*pswMsk]
    [*pswField]->pFeld->bArt & IS_EINGABE)) *pswField--;}

if(aswAktLine_g[*pswMsk] < 0) aswAktLine_g[*pswMsk]=0;
if(aswAktLine_g[*pswMsk] > awMaxLine_g[*pswMsk] -1)
  awMaxLine_g[*pswMsk]=aswAktLine_g[*pswMsk] +1;

if(lBlockVer_g&lBlock && awBlockLen_g[*pswMsk]
  && *pswField >= awBlocks[*pswMsk][0] &&
  *pswField <= awBlocks[*pswMsk][1])
  aboInBlock_g[*pswMsk]=JA;
else
  {aswAktLine_g[*pswMsk]=0;
  aboInBlock_g[*pswMsk]=NEIN;}

return;
} /* end M_KeyEvaluation() */



