/*.ta Dl_HilfeIndex()
╔══════════════════════════════════════════════════════════════════════════════╗
║  Dl_HilfeIndex()							       ║
╚══════════════════════════════════════════════════════════════════════════════╝

Überblick:
────────────────────────────────────────────────────────────────────────────────
#include <eur_dlg.h>
WORD Dl_HilfeIndex(pHilfeIndex);

Parameter:
────────────────────────────────────────────────────────────────────────────────
HILFEINDEX  pHilfeIndex  Zeiger auf Array aus Strukturen des Typs HILFEINDEX.


Beschreibung:
────────────────────────────────────────────────────────────────────────────────
Diese Funktion baut ein Hilfe-Fenster auf, in dem der Anwender aus einem
Hilfe-Index das Thema auswählen kann, zu dem er Hilfe anfordern will. Diese
Dialogfeld ist Bestandteil des SAA-Konzeptes. Nach den Tastenzuordnungen von
SAA sollen Sie dem Anwender mit der Taste [F11] (auf dem PC durch [Alt][F1]
simuliert) Zugang zum Hilfeindex bieten. Dies Tastenbelegung findet auch bei
Shell von DOS 4.0 Verwendung. Der Session-Manager von OS/2 verwendet für den
gleichen Zweck die Taste [F5].

Übergeben Sie der Funktion einen Zeiger auf ein Array von Daten des Struktur-
typs HILFEINDEX. Dieser Strukturtyp ist in der Datei <eur_dlg.h> folgender-
maßen definiert:

typedef struct
{
     PSTR pstrText;
     WORD wRueckgabe;
} HILFEINDEX;

Tragen Sie bei der Initialisierung für das Strukturelement pstrText das Thema
und für wRueckgabe den Wert ein, den Sie zurück erhalten wollen, wenn der
Anwender dieses Thema selektiert.

Initialisieren Sie das letzte Element des Array expliziet als NULL-Zeiger,
damit die Funktion das Ende der Initialisierungen erkennen kann. Verwenden Sie
für wRueckgabe nicht die Zahl Null, da dieser Rückgabewert das Abbrechen der
Funktion durch den Anwender signalisiert.

Die einzelnen Einträge des Index können maximal 52 Zeichen lang sein. Wenn
der Index mehr als acht Zeilen/Einträge umfaßt, stellt die Funktion dem
Anwender eine Scroll-Möglichkeit zur Verfügung.

Der Anwender kann mit der Tastatur ein Thema auswählen, indem er mit den
Cursor-Tasten ein Thema auswählt und anschließend mit [Return] bestätigt.

Bei einer aktiven Maus kann der Auswahlcursor verschoben werden, indem der
Anwender den Mauszeiger auf die Scrollpfeile bewegt, die sich auf der oberen
Trennlinie im Fenster befinden, und dort die linke Maustaste drückt. Außer-
dem kann der Anwender ein Thema makieren, indem er mit dem Mauszeiger auf den
Eintrag zeigt und dort die linke Maustaste drückt. Mit einem Doppelklick wird
das Thema ausgewählt, auf das der Mauszeiger beim Klicken zeigt.
.ff
Im unteren Bereich der Dialogbox befinden sich drei Schaltflächen:

- Mit der [Esc]-Schaltfläche kann der Anwender die Hilfe beenden.
  Die Funktion gibt dann den Wert der Konstanten DLG_ESC (definiert mit
  dem Wert 0) zurück.
- Mit der [F1]-Schaltfläche kann Hilfe zur Bedienung der Dialogbox angefordert
  werden. Diese Hilfe wird von der Toolbox zur Verfügung gestellt.
- Mit der Eingabe-Schaltfläche wählt der Anwender das Thema unter dem
  Auswahl-Cursor aus. Rufen Sie anschließend die Funktion Dl_Hilfe() oder
  Dl_HilfeTools() auf, um die angefeorderte Hilfe anzuzeigen.


Rückgabewert:
────────────────────────────────────────────────────────────────────────────────
WORD  Auswahl   DLG_ESC == 0  Funktion abgebrochen,
                sonst      Eintrag in wRueckgabe für gewähltes Thema


Benutzte globale Variablen (R/W):
────────────────────────────────────────────────────────────────────────────────
- aCS_g[]    (R)            - pstrEsc_g   (R)         - pstrReturn_g (R)
- wCSInd_g   (R)            - pstrF1_g    (R)
- wMausda_g  (R)            - boBeepen_g  (R)

.de \euro\demo\dmohilf2.c
.ff
.te*/


/*╔════════════════════════════════════════════════════════════════════════╗
  ║                        DEKLARATIONS-DATEIEN                            ║
  ╚════════════════════════════════════════════════════════════════════════╝*/
#include <eur_tool.h>
#include <stdio.h>
#include <string.h>


/*╔════════════════════════════════════════════════════════════════════════╗
  ║             GLOBALE VARIABLEN, DEFINITION UND REFERENZEN               ║
  ╚════════════════════════════════════════════════════════════════════════╝*/
IMPORT COLORSET aCS_g[];                            /* Farbpaletten-Array   */
IMPORT WORD     wCSInd_g;                           /* Index in Pal.-Array  */
IMPORT WORD     wMausda_g;                          /* Maus im System ?     */

IMPORT PSTR     pstrF1_g;                           /* Texte der Schalt-    */
IMPORT PSTR     pstrEsc_g;                          /* flächen              */
IMPORT PSTR     pstrReturn_g;
IMPORT BOOL     boBeepen_g;                         /* Warnton ein ?        */

/*╔════════════════════════════════════════════════════════════════════════╗
  ║                        MODULGLOBALE VARIABLEN                          ║
  ╚════════════════════════════════════════════════════════════════════════╝*/
STATIC	PSTR   pstrHI_m     = "Index der Hilfsbildschirme";
STATIC	WORD   wHilfsZeilen_m,
               wAktZeile_m,
               wIndex_m;


/*╔════════════════════════════════════════════════════════════════════════╗
  ║                        MODULGLOBALE FUNKTIONEN                         ║
  ╚════════════════════════════════════════════════════════════════════════╝*/
STATIC	VOID cdecl i_BalkenPlusEins	  (PHILFEINDEX);
STATIC	VOID cdecl i_BalkenMinusEins	  (PHILFEINDEX);
STATIC	VOID cdecl i_ZeichneScroller	  (VOID);


/*╔════════════════════════════════════════════════════════════════════════╗
  ║                        KONSTANTEN UND MAKROS                           ║
  ╚════════════════════════════════════════════════════════════════════════╝*/
#define SPA         9                               /* Spalte des Dialoges  */
#define ZEI         5                               /* Zeile des Dialoges   */
#define BRE        56                               /* Breite des Dialoges  */
#define HOE        14                               /* Höhe des Dialoges    */
#define TEXTZEILEN  8                               /* Anzahl Hilfszeilen   */
#define MINZEILEN   5                               /* min. Anzahl Hilfsz.  */

#define DKLICK 6


#define ZEICHNEBALKEN(z)    Wi_Swa(1,z+2, 52,1,aCS_g[wCSInd_g].wCs_mf_ca)
#define LOESCHEBALKEN(z)    Wi_Swa(1,z+2, 52,1,aCS_g[wCSInd_g].wCs_dlg)


/*╔════════════════════════════════════════════════════════════════════════╗
  ║                          FUNKTIONS-DEFINITION                          ║
  ╚════════════════════════════════════════════════════════════════════════╝*/
GLOBAL
WORD Dl_HilfeIndex(PHILFEINDEX pHilfeIndex)
{
    REGISTER    i;
    PWKB        pWkbDialog;

    EVENT       Event;                              /* Zeiger für Event     */
    PEVENT      pEvent;
    PHILFEINDEX pHILokal;                           /* lokaler Zeiger Texte */
    LONG        lTicksEins;                         /* zur Erkennung Doppel-*/
                                                    /*    klick             */

    i_InitVars();                                   /* glo. Var. init.      */
    pEvent = &Event;                                /* Var. initialisieren  */

    pHILokal = pHilfeIndex;
    for (wHilfsZeilen_m=0;                          /* Anzahl der Hilfs-    */
         pHILokal->pstrText != NULL;                /* zeilen ermitteln     */
         wHilfsZeilen_m++, pHILokal++);
    pHILokal = pHilfeIndex;                         /* Zeiger zurücksetzen  */

    wAktZeile_m = 0;
    wIndex_m    = 0;

    if ((pWkbDialog=Wi_Einrichten(SPA,ZEI,BRE,HOE)) /* Fenster einrichten   */
        == NULL)
        return (ERROR);                             /* eventuell Abbruch    */

    i_Dl_Init(SPA, ZEI, BRE, HOE,		    /* Fenster anzeigen     */
              pstrHI_m,
              pWkbDialog,
              SF_STANDARD,
              DLG_INFO);

    for (i = 0;i < TEXTZEILEN ;pHILokal++, i++)     /* Text ausgeben        */
	Wi_Ss(1, i+2, pHILokal->pstrText);

    ZEICHNEBALKEN(wAktZeile_m);                     /* Auswahlcursor        */
    i_ZeichneScroller();                            /* Scrollpfeile         */


    for(;;)                                         /* Eingaberoutine       */
    {
	Ut_Event(pEvent);
        switch(pEvent->wArt)
        {
            case EVENT_TASTE:
                switch(pEvent->wTaste)
                {
                    case T_DOWN:
                        i_BalkenPlusEins(pHilfeIndex);
                        break;

                    case T_UP:
                         i_BalkenMinusEins(pHilfeIndex);
                         break;

                    case T_F1:
			Dl_HilfeTools(DLGINDEX);
                        break;

                    case T_ESC:
			Wi_Entfernen(pWkbDialog);
                        return(DLG_ESC);

                    case T_RETURN:
			Wi_Entfernen(pWkbDialog);
                        pHILokal = pHilfeIndex+wIndex_m;
                        return(pHILokal->wRueckgabe);
                    default:
                        if (boBeepen_g)
                            i_Beep();
                }
                break;


            case EVENT_L_PRESS:
                if (pEvent->wZeile == (ZEI+2) )
                {
                    if (pEvent->wSpalte == (SPA+51))
                        i_BalkenMinusEins(pHilfeIndex);
                    else if (pEvent->wSpalte == (SPA+53))
                        i_BalkenPlusEins(pHilfeIndex);
                }

                else if (pEvent->wZeile == (ZEI+12))
                {
                    if (pEvent->wSpalte > SPA+2 &&
                            pEvent->wSpalte < SPA+3+strlen(pstrReturn_g))
                        {
			    Wi_Entfernen(pWkbDialog);
                            pHILokal = pHilfeIndex+wIndex_m;
                            return(pHILokal->wRueckgabe);
                        }

                    else if (pEvent->wSpalte > SPA+16 &&
                            pEvent->wSpalte < SPA+17+strlen(pstrEsc_g))
                        {
			    Wi_Entfernen(pWkbDialog);
                            return(DLG_ESC);
                        }

                    else if (pEvent->wSpalte > SPA+30 &&
                            pEvent->wSpalte < SPA+31+strlen(pstrF1_g))
				 Dl_HilfeTools(DLGINDEX);
                }

                                                    /* Klick im Themen-      */
                                                    /* bereich ?             */
                else if( pEvent->wZeile  >= (ZEI+3)  &&
                         pEvent->wZeile  <= (ZEI+10) &&
                         pEvent->wSpalte >= (SPA+2)  &&
                         pEvent->wSpalte <= (SPA+BRE-3) )
                {
                                                    /* Doppelklick testen   */
                    if (pEvent->wZeile - (ZEI+3) == wAktZeile_m &&
                        pEvent->lTicks - lTicksEins < DKLICK )
                        {
			    Wi_Entfernen(pWkbDialog);
                            pHILokal = pHilfeIndex+wIndex_m;
                            return(pHILokal->wRueckgabe);
                    }

                    if (pEvent->wZeile-(ZEI+3) >= 0  &&  /* kein Doppelklick   */
                        pEvent->wZeile-(ZEI+3) < wHilfsZeilen_m)
                    {
                        lTicksEins = pEvent->lTicks;
                        if (wAktZeile_m != pEvent->wZeile-(ZEI+3))
                        {
                            LOESCHEBALKEN(wAktZeile_m);
                            if (wAktZeile_m == wIndex_m)
                                wIndex_m =
                                    wAktZeile_m= pEvent->wZeile - (ZEI+3);
                            else
                            {
                                wIndex_m = wIndex_m - wAktZeile_m;
                                wAktZeile_m = pEvent->wZeile-(ZEI+3);
                                wIndex_m += wAktZeile_m;
                            }
                            ZEICHNEBALKEN(wAktZeile_m);
                            i_ZeichneScroller();
                        }
                    }
                }
                else if (boBeepen_g)
                    i_Beep();
                break;
        } /* end of switch(pEvent->wArt) */
    } /* end of for */
}



/*╔════════════════════════════════════════════════════════════════════════╗
  ║  Funktionsname:    i_BalkenPlusEins               Datum: 25.10.88      ║
  Ã────────────────────────────────────────────────────────────────────────Â
  ║                                                                        ║
  ║  Parameter:        keine                                               ║
  ║                                                                        ║
  ║  Beschreibung:     Diese Funktion steuert das Scrollen und die Neu-    ║
  ║		       ausgabe des Hilfstextes bei Dl_HilfeIndex().	   ║
  ║                    In diesem Fall wird der im Fenster stehende         ║
  ║                    Text gescrollt, der neue Text ausgegeben und        ║
  ║                    die Scroll-Pfeile an die nach dem Scrollen ent-     ║
  ║                    standene Situation angepaßt.                        ║
  ║                                                                        ║
  ║  Rückgabewert:     keine                                               ║
  ║                                                                        ║
  ║  Benutzte globale                                                      ║
  ║  Variablen (R/W):  modulglobale Variablen:                             ║
  ║                    - wHilfsZeilen_m (R)                                ║
  ║                    - wStartzeile_m  (R/W)                              ║
  ║                    - ppstrTmp_m     (R)                                ║
  ║                                                                        ║
  ╚════════════════════════════════════════════════════════════════════════╝*/
STATIC
VOID i_BalkenPlusEins(PHILFEINDEX pHI)
{
    PHILFEINDEX pHILokal;
    pHILokal = pHI;

    if (wAktZeile_m == TEXTZEILEN-1 &&              /* wenn Balken in Zeile */
        wIndex_m < wHilfsZeilen_m-1)                /* 8, Fenster scrollen  */
    {
        LOESCHEBALKEN(wAktZeile_m);
	i_Dl_Scroll((SPA+1),(ZEI+3),(BRE+SPA-2),(ZEI+10),UP);
        wIndex_m++;
        pHILokal += wIndex_m;
	Wi_Ss(1,9, pHILokal->pstrText);
        ZEICHNEBALKEN(wAktZeile_m);
    }

    else if (wAktZeile_m < TEXTZEILEN &&            /* bis Zeile 8 nur den  */
        wIndex_m < wHilfsZeilen_m-1)                /* Balken verschieben   */
    {
        LOESCHEBALKEN(wAktZeile_m);
        wIndex_m++;
        wAktZeile_m++;
        ZEICHNEBALKEN(wAktZeile_m);
    }
    else if (boBeepen_g)
        i_Beep();
    i_ZeichneScroller();

    return;
}




/*╔════════════════════════════════════════════════════════════════════════╗
  ║  Funktionsname:    i_BalkenMinusEins              Datum: 25.10.88      ║
  Ã────────────────────────────────────────────────────────────────────────Â
  ║                                                                        ║
  ║  Parameter:        PPSTR ppstrTxt  Zeiger auf erste Zeile der          ║
  ║                                    Hilfstexte                          ║
  ║                                                                        ║
  ║  Beschreibung:     Diese Funktion steuert das Scrollen und die  Neu-   ║
  ║                    ausgabe des Hilfstextes.                            ║
  ║                    Eine Aktion wird erst dann ausgeführt, wenn         ║
  ║                    mehr als die in der Konstante MINZEILEN angegebenen ║
  ║                    Zeilen noch im Fenster stehen.                      ║
  ║                    In diesem Fall wird der im Fenster stehende         ║
  ║                    Text gescrollt, der neue Text ausgegeben und        ║
  ║                    die Scroll-Pfeile an die nach dem Scrollen ent-     ║
  ║                    standene Situation angepaßt.                        ║
  ║                                                                        ║
  ║  Rückgabewert:     Diese Funktion hat keinen Rückgabewert.             ║
  ║                                                                        ║
  ║  Benutzte globale                                                      ║
  ║  Variablen (R/W):  modulglobale Variablen:                             ║
  ║                    - wHilfsZeilen_m (R)                                ║
  ║                    - wStartzeile_m  (R/W)                              ║
  ║                    - ppstrTmp_m     (R)                                ║
  ║                    - wIndex_m       (R/W)                              ║
  ╚════════════════════════════════════════════════════════════════════════╝*/
STATIC
VOID i_BalkenMinusEins(PHILFEINDEX pHI)
{
    PHILFEINDEX pHILokal;

    if (wAktZeile_m == 0 &&                         /* wenn Balken in Zeile */
        wIndex_m    != 0)                           /* 0, Fenster scrollen  */
    {
        LOESCHEBALKEN(wAktZeile_m);
	i_Dl_Scroll((SPA+1),(ZEI+3),(BRE+SPA-2),(ZEI+10),DOWN);
        wIndex_m--;
        pHILokal = pHI;
        pHILokal += wIndex_m;
	Wi_Ss(1,2, pHILokal->pstrText);
        ZEICHNEBALKEN(wAktZeile_m);
    }

    else if (wAktZeile_m > 0 &&                   /* sonst nur den Auswahl- */
        wIndex_m < wHilfsZeilen_m)                /* Balken verschieben     */
    {
        LOESCHEBALKEN(wAktZeile_m);
        wIndex_m--;
        wAktZeile_m--;
        ZEICHNEBALKEN(wAktZeile_m);
    }

    else if(boBeepen_g)
        i_Beep();

    i_ZeichneScroller();

    return;
}


/*╔════════════════════════════════════════════════════════════════════════╗
  ║  Funktionsname:    i_ZeichneScroller              Datum: 31.10.88      ║
  Ã────────────────────────────────────────────────────────────────────────Â
  ║                                                                        ║
  ║  Parameter:        keine                                               ║
  ║                                                                        ║
  ║  Beschreibung:     Diese Funktion testet die Bedingungen für           ║
  ║                    die Anzeige der Scrollpfeile und gibt die           ║
  ║                    Pfeile entsprechend aus.                            ║
  ║                                                                        ║
  ║  Rückgabewert:     keine                                               ║
  ║                                                                        ║
  ║                                                                        ║
  ║  Benutzte globale                                                      ║
  ║  Variablen (R/W):  modulglobale:                                       ║
  ║                    - wAktZeile_m      (R)                              ║
  ║                    - wIndex_m         (R)                              ║
  ║                    - wHilfsZeilen_m   (R)                              ║
  ║                                                                        ║
  ╚════════════════════════════════════════════════════════════════════════╝*/
STATIC
VOID i_ZeichneScroller(VOID)
{
    if( wIndex_m == wHilfsZeilen_m-1)
	Wi_Sza(52,1,'─',aCS_g[wCSInd_g].wCs_dlg);
    else
	Wi_Sza(52,1,'',aCS_g[wCSInd_g].wCs_dlg_sp);

    if( wIndex_m == 0)
	Wi_Sza(50,1,'─',aCS_g[wCSInd_g].wCs_dlg);
    else
	Wi_Sza(50,1,'',aCS_g[wCSInd_g].wCs_dlg_sp);

    return;
}




